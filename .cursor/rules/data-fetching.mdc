# ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»TanStack Query ãƒ«ãƒ¼ãƒ«

## ğŸ”„ TanStack Query åŸºæœ¬ãƒ«ãƒ¼ãƒ«

### useQueryä½¿ç”¨æ–¹é‡
- **å¿…é ˆ**: ã™ã¹ã¦ã®APIå‘¼ã³å‡ºã—ã«`useQuery`ã¾ãŸã¯`useMutation`ã‚’ä½¿ç”¨
- **å¿…é ˆ**: queryKeyã¯é…åˆ—å½¢å¼ã§æ˜ç¢ºã«å‘½å
- **æ¨å¥¨**: enabledã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ¡ä»¶ä»˜ãå®Ÿè¡Œ

```typescript
// âœ… Good
const { data: articles, isLoading, isError } = useQuery({
  queryKey: ['articles', { page: 1, category: 'tech' }],
  queryFn: () => fetchArticles({ limit: 10, offset: 0 }),
  enabled: !!categoryId, // æ¡ä»¶ä»˜ãå®Ÿè¡Œ
});

// âŒ Bad
const { data } = useQuery(['data'], getData); // æ›–æ˜§ãªqueryKey
```

### queryKeyå‘½åè¦å‰‡
- **æ§‹é€ **: `[ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå, ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ]`
- **ä¾‹**:
  - `['articles']` - å…¨è¨˜äº‹
  - `['articles', { page: 1 }]` - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ä»˜ã
  - `['articles', id]` - ç‰¹å®šè¨˜äº‹
  - `['categories']` - ã‚«ãƒ†ã‚´ãƒªä¸€è¦§

```typescript
// âœ… ä¸€è²«ã—ãŸqueryKeyè¨­è¨ˆ
const articlesQueryKey = (params?: ArticleSearchParams) =>
  params ? ['articles', params] : ['articles'];

const articleQueryKey = (id: string) => ['articles', id];
const categoriesQueryKey = () => ['categories'];
```

## ğŸ“¦ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯è¨­è¨ˆ

### APIå‘¼ã³å‡ºã—ãƒ•ãƒƒã‚¯
- **å ´æ‰€**: `src/hooks/api/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆä»Šå¾Œä½œæˆï¼‰
- **å‘½å**: `use + ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå`
- **è²¬ä»»**: ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†

```typescript
// src/hooks/api/useArticles.ts
export const useArticles = (params?: ArticleSearchParams) => {
  return useQuery({
    queryKey: ['articles', params],
    queryFn: () => fetchArticles(params),
    staleTime: 5 * 60 * 1000, // 5åˆ†
  });
};

// src/hooks/api/useArticle.ts
export const useArticle = (id: string) => {
  return useQuery({
    queryKey: ['articles', id],
    queryFn: () => fetchArticle(id),
    enabled: !!id,
  });
};
```

### ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
- **é€šå¸¸**: `useQuery`ã§ãƒšãƒ¼ã‚¸å˜ä½
- **ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«**: `useInfiniteQuery`ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

```typescript
// ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
export const useArticlesWithPagination = (page: number = 1, limit: number = 10) => {
  return useQuery({
    queryKey: ['articles', { page, limit }],
    queryFn: () => fetchArticles({
      limit,
      offset: (page - 1) * limit
    }),
    keepPreviousData: true, // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆæ™‚ã®UXæ”¹å–„
  });
};
```

## âš¡ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

### è¨­å®šæ¸ˆã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- **staleTime**: 5åˆ†ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒæ–°é®®ã¨ã¿ãªã•ã‚Œã‚‹æ™‚é–“ï¼‰
- **gcTime**: 30åˆ†ï¼ˆã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ™‚é–“ï¼‰
- **refetchOnWindowFocus**: falseï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®å†å–å¾—ç„¡åŠ¹ï¼‰

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
- **è¨˜äº‹æ›´æ–°æ™‚**: é–¢é€£ã™ã‚‹queryKeyã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
- **ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚**: è¨˜äº‹ä¸€è¦§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–

```typescript
// ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
const mutation = useMutation({
  mutationFn: updateArticle,
  onSuccess: (data) => {
    // ç‰¹å®šè¨˜äº‹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
    queryClient.invalidateQueries({ queryKey: ['articles', data.id] });
    // è¨˜äº‹ä¸€è¦§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
    queryClient.invalidateQueries({ queryKey: ['articles'] });
  },
});
```

## ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### API ã‚¨ãƒ©ãƒ¼
- **å¿…é ˆ**: `isError`çŠ¶æ…‹ã‚’é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- **æ¨å¥¨**: Error Boundaryã¨ã®çµ„ã¿åˆã‚ã›ï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰
- **ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£**: åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

```typescript
const ArticleList = () => {
  const { data: articles, isLoading, isError, error } = useArticles();

  if (isLoading) return <LoadingSkeleton />;

  if (isError) {
    return (
      <ErrorMessage
        title="è¨˜äº‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
        message={error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}
        onRetry={() => refetch()}
      />
    );
  }

  return <ArticleGrid articles={articles?.contents || []} />;
};
```

### ãƒªãƒˆãƒ©ã‚¤è¨­å®š
- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: 2å›ãƒªãƒˆãƒ©ã‚¤ï¼ˆquery.tsè¨­å®šæ¸ˆã¿ï¼‰
- **é–“éš”**: æŒ‡æ•°é–¢æ•°çš„å¢—åŠ ï¼ˆ1ç§’â†’2ç§’â†’4ç§’ï¼‰
- **ã‚«ã‚¹ã‚¿ãƒ **: é‡è¦ãªAPIã«ã¯å€‹åˆ¥è¨­å®š

```typescript
// é‡è¦ãªAPIã«ã¯å€‹åˆ¥ã®ãƒªãƒˆãƒ©ã‚¤è¨­å®š
const { data } = useQuery({
  queryKey: ['critical-data'],
  queryFn: fetchCriticalData,
  retry: 3, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ˆã‚Šå¤šããƒªãƒˆãƒ©ã‚¤
  retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 10000),
});
```

## ğŸ”„ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ç®¡ç†

### çŠ¶æ…‹ãƒ•ãƒ©ã‚°
- **isLoading**: åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚
- **isFetching**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ›´æ–°æ™‚
- **isPending**: ä¿ç•™çŠ¶æ…‹
- **isRefetching**: æ‰‹å‹•å†å–å¾—æ™‚

```typescript
// é©åˆ‡ãªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
const ArticleDetail = ({ id }: { id: string }) => {
  const { data: article, isLoading, isFetching } = useArticle(id);

  // åˆå›ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
  if (isLoading) return <ArticleSkeleton />;

  return (
    <div className="relative">
      {/* ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ›´æ–°ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */}
      {isFetching && (
        <div className="absolute top-2 right-2">
          <LoadingSpinner size="sm" />
        </div>
      )}

      <ArticleContent article={article} />
    </div>
  );
};
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ
- **æ¨å¥¨**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•ã‚’äºˆæ¸¬ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆèª­ã¿
- **ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: ãƒ›ãƒãƒ¼æ™‚ã€ãƒšãƒ¼ã‚¸é·ç§»å‰

```typescript
// ãƒ›ãƒãƒ¼æ™‚ã®ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ
const ArticleCard = ({ article }: { article: Article }) => {
  const queryClient = useQueryClient();

  const handleMouseEnter = () => {
    queryClient.prefetchQuery({
      queryKey: ['articles', article.id],
      queryFn: () => fetchArticle(article.id),
    });
  };

  return (
    <div onMouseEnter={handleMouseEnter}>
      {/* ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
    </div>
  );
};
```

### ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ›´æ–°
- **è‡ªå‹•**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†æ¥ç¶šæ™‚
- **æ‰‹å‹•**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ“ä½œ

## ğŸ§¹ ä¸è¦ãªãƒ•ãƒƒã‚¯ã®å‰Šé™¤

### å‰Šé™¤ã®åˆ¤æ–­åŸºæº–
- **é‡è¤‡æ©Ÿèƒ½**: æ—¢å­˜ã®ãƒ•ãƒƒã‚¯ã§åŒã˜æ©Ÿèƒ½ãŒå®Ÿç¾ã§ãã‚‹å ´åˆ
- **ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„**: ã©ã“ã‹ã‚‰ã‚‚å‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ãƒ•ãƒƒã‚¯
- **è¨­å®šã®å•é¡Œ**: microCMSã®è¨­å®šã¨åˆã‚ãªã„ãƒ•ãƒƒã‚¯

### å‰Šé™¤æ‰‹é †
1. **ä½¿ç”¨ç®‡æ‰€ã®ç¢ºèª**: ã©ã“ã‹ã‚‰ã‚‚å‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
2. **é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤**: ãƒ•ãƒƒã‚¯ã€ã‚¯ã‚¨ãƒªã‚­ãƒ¼ã€APIé–¢æ•°ã‚’å‰Šé™¤
3. **ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®å‰Šé™¤**: index.tsã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’å‰Šé™¤
4. **å‹å®šç¾©ã®æ›´æ–°**: é–¢é€£ã™ã‚‹å‹å®šç¾©ã‹ã‚‰ä¸è¦ãªé …ç›®ã‚’å‰Šé™¤
5. **ãƒ“ãƒ«ãƒ‰ç¢ºèª**: `pnpm build`ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª

### å‰Šé™¤ä¾‹
```typescript
// âŒ å‰Šé™¤å¯¾è±¡ - é‡è¤‡æ©Ÿèƒ½
export const useLatestArticles = (limit: number = 10) => {
  return useQuery({
    queryKey: createLatestArticlesQueryKey(limit),
    queryFn: () => fetchLatestArticles(limit),
    staleTime: 2 * 60 * 1000,
  });
};

// âœ… ä»£æ›¿æ¡ˆ - æ—¢å­˜ã®ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨
const { data: articlesResponse } = useArticles({
  limit: 6,
  orders: '-publishedAt',
});
const articles = articlesResponse?.contents || [];
```

### å‰Šé™¤æ™‚ã®æ³¨æ„ç‚¹
- **æ®µéšçš„å‰Šé™¤**: ä¸€åº¦ã«å‰Šé™¤ã›ãšã€é–¢é€£ã™ã‚‹ç®‡æ‰€ã‚’é †æ¬¡å‰Šé™¤
- **ãƒ“ãƒ«ãƒ‰ç¢ºèª**: å„æ®µéšã§ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
- **å‹å®‰å…¨æ€§**: å‰Šé™¤å¾Œã‚‚å‹å®‰å…¨æ€§ã‚’ç¶­æŒ

---

**æœ€çµ‚æ›´æ–°**: 2024å¹´7æœˆï¼ˆIssue #35å®Œäº†æ™‚ç‚¹ï¼‰


**æœ€çµ‚æ›´æ–°**: 2024å¹´7æœˆ
